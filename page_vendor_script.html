<!-- page_vendor_script.html -->

<script>
    $(document).ready(function() {

        // ==================== GLOBAL STATE ====================
        let availablePackages = [], availableStatuses = [], availableProjectTypes = [], availableProjectOwners = [];
        let currentPage = 1, totalPages = 1;
        let searchTerm = '', selectedStatusId = '', selectedPackageId = '';
        let sortState = { column: 'Id', direction: 'asc' };
        let debounceTimer;

        // ==================== GLOBAL ACTION FUNCTIONS (for onclick attributes) ====================
        window.prepareAddVendorModal = function() {
            $('#vendorForm')[0].reset();
            $('#vendorId').val('');
            $('#vendorModalLabel').text('เพิ่มข้อมูล Vendor ใหม่');
            setModalLoading(false);
            toggleFileSections();
            loadInitialDataForModal().then(() => {
                $('#packageIds, #projectPackageIds').val(null).trigger('change');
            });
            $('#vendorTab a:first').tab('show');
            $('#vendor-folder-link').hide();
            $('#addContactBtn, #addBoardMemberBtn, #addFinanceBtn, #addProjectBtn').prop('disabled', true);
            $('#vendorModal').modal('show');
        };

        window.prepareEditVendorModal = function(vendorId) {
            $('#addContactBtn, #addBoardMemberBtn, #addFinanceBtn, #addProjectBtn').prop('disabled', false);
            $('#vendorModalLabel').text('แก้ไขข้อมูล Vendor');
            setModalLoading(true);
            $('#vendorTab a:first').tab('show');
            $('#vendorModal').modal('show');
            Promise.all([
                loadInitialDataForModal(),
                serverCall('getVendorDetailsById', vendorId),
                serverCall('getContactsByVendorId', vendorId),
                serverCall('getBoardMembersByVendorId', vendorId),
                serverCall('getFinanceByVendorId', vendorId),
                serverCall('getProjectsByVendorId', vendorId)
            ]).then(([, vendorData, contactsData, boardData, financeData, projectsData]) => {
                if (!vendorData) { showToast('ไม่พบข้อมูล Vendor', false); $('#vendorModal').modal('hide'); return; }
                populateForm(vendorData);
                renderContactsTable(contactsData);
                renderBoardMembersTable(boardData);
                renderFinanceTable(financeData);
                renderProjectsTable(projectsData);
                setModalLoading(false);
            }).catch(err => { handleServerError(err); $('#vendorModal').modal('hide'); });
        };
        
        window.handleDeleteVendor = function(vendorId) { Swal.fire({ title: 'คุณแน่ใจหรือไม่?', text: `คุณกำลังจะลบข้อมูล Vendor (ID: ${vendorId}) พร้อมไฟล์ทั้งหมด`, icon: 'warning', showCancelButton: true, confirmButtonColor: '#d33', confirmButtonText: 'ใช่, ลบเลย!', cancelButtonText: 'ยกเลิก', showLoaderOnConfirm: true, preConfirm: () => serverCall('processDeleteVendor', vendorId).catch(error => Swal.showValidationMessage(`เกิดข้อผิดพลาด: ${error.message}`)), allowOutsideClick: () => !Swal.isLoading() }).then(result => { if (result.isConfirmed && result.value.success) { Swal.fire('ลบสำเร็จ!', result.value.message, 'success'); fetchAndRenderVendors(); } else if (result.value) { Swal.fire('เกิดข้อผิดพลาด!', result.value.message, 'error'); } }); };
        window.prepareAddContactModal = function() { const currentVendorId = $('#vendorId').val(); if (!currentVendorId) { showToast('กรุณาบันทึกข้อมูล Vendor หลักก่อน', false); return; } $('#contactForm')[0].reset(); $('#contactId').val(''); $('#contactVendorId').val(currentVendorId); $('#contactModalLabel').text('เพิ่มข้อมูลผู้ติดต่อ'); $('#contactModal').modal('show'); };
        window.prepareEditContactModal = function(contactData) { $('#contactForm')[0].reset(); $('#contactModalLabel').text('แก้ไขข้อมูลผู้ติดต่อ'); $('#contactId').val(contactData.Id); $('#contactVendorId').val(contactData.VendorId); $('#contactName').val(contactData.Name || ''); $('#contactPosition').val(contactData.Position || ''); $('#contactEmail').val(contactData.Email || ''); $('#contactPhoneNumber').val(contactData.PhoneNumber ? String(contactData.PhoneNumber).replace(/'/g, '') : ''); $('#contactLineId').val(contactData.LineId || ''); $('#contactModal').modal('show'); };
        window.handleDeleteContact = function(contactId, vendorId) { Swal.fire({ title: 'ยืนยันการลบ', text: "คุณต้องการลบผู้ติดต่อรายนี้ใช่หรือไม่?", icon: 'warning', showCancelButton: true, confirmButtonColor: '#d33', confirmButtonText: 'ใช่, ลบเลย!', cancelButtonText: 'ยกเลิก', showLoaderOnConfirm: true, preConfirm: () => serverCall('processDeleteContact', contactId, vendorId).catch(error => Swal.showValidationMessage(`เกิดข้อผิดพลาด: ${error.message}`)), allowOutsideClick: () => !Swal.isLoading() }).then(result => { if (result.isConfirmed && result.value.success) { showToast(result.value.message, true); renderContactsTable(result.value.contacts); } else if (result.value) { showToast(result.value.message, false); } }); };
        window.prepareAddBoardMemberModal = function() { const currentVendorId = $('#vendorId').val(); if (!currentVendorId) { showToast('กรุณาบันทึกข้อมูล Vendor หลักก่อน', false); return; } $('#boardMemberForm')[0].reset(); $('#boardMemberId').val(''); $('#boardMemberVendorId').val(currentVendorId); $('#boardMemberModalLabel').text('เพิ่มข้อมูลกรรมการ'); $('#boardMemberModal').modal('show'); };
        window.prepareEditBoardMemberModal = function(memberData) { $('#boardMemberForm')[0].reset(); $('#boardMemberModalLabel').text('แก้ไขข้อมูลกรรมการ'); $('#boardMemberId').val(memberData.Id); $('#boardMemberVendorId').val(memberData.VendorId); $('#boardMemberName').val(memberData.Name || ''); $('#boardMemberSurname').val(memberData.Surname || ''); $('#boardMemberModal').modal('show'); };
        window.handleDeleteBoardMember = function(memberId, vendorId) { Swal.fire({ title: 'ยืนยันการลบ', text: "คุณต้องการลบข้อมูลกรรมการท่านนี้ใช่หรือไม่?", icon: 'warning', showCancelButton: true, confirmButtonColor: '#d33', confirmButtonText: 'ใช่, ลบเลย!', cancelButtonText: 'ยกเลิก', showLoaderOnConfirm: true, preConfirm: () => serverCall('processDeleteBoardMember', memberId, vendorId).catch(error => Swal.showValidationMessage(`เกิดข้อผิดพลาด: ${error.message}`)), allowOutsideClick: () => !Swal.isLoading() }).then(result => { if (result.isConfirmed && result.value.success) { showToast(result.value.message, true); renderBoardMembersTable(result.value.members); } else if (result.value) { showToast(result.value.message, false); } }); };
        window.prepareAddFinanceModal = function() { const currentVendorId = $('#vendorId').val(); if (!currentVendorId) { showToast('กรุณาบันทึกข้อมูล Vendor หลักก่อน', false); return; } $('#financeForm')[0].reset(); $('#financeId').val(''); $('#financeVendorId').val(currentVendorId); $('#financeModalLabel').text('เพิ่มข้อมูลงบการเงิน'); setFinanceModalLoading(false); $('#financeModal').modal('show'); };
        window.prepareEditFinanceModal = function(financeId) { $('#financeModalLabel').text('แก้ไขข้อมูลงบการเงิน'); setFinanceModalLoading(true); $('#financeModal').modal('show'); serverCall('getFinanceRecordById', financeId).then(recordData => { if (!recordData) { showToast('ไม่สามารถดึงข้อมูลได้', false); $('#financeModal').modal('hide'); return; } $('#financeForm')[0].reset(); $('#financeId').val(recordData.Id); $('#financeVendorId').val(recordData.VendorId); $('#financeYear').val(recordData.Year || ''); $('#financeRevenue').val(recordData.Revenue || ''); $('#financeCurrentAssets').val(recordData.CurrentAssets || ''); $('#financeCurrentLiabilities').val(recordData.CurrentLiabilities || ''); $('#financeTotalLiabilities').val(recordData.TotalLiabilities || ''); setFinanceModalLoading(false); }).catch(err => { handleServerError(err); $('#financeModal').modal('hide'); }); };
        window.handleDeleteFinanceRecord = function(financeId, vendorId) { Swal.fire({ title: 'ยืนยันการลบ', text: "คุณต้องการลบข้อมูลงบการเงินรายการนี้ใช่หรือไม่?", icon: 'warning', showCancelButton: true, confirmButtonColor: '#d33', confirmButtonText: 'ใช่, ลบเลย!', cancelButtonText: 'ยกเลิก', showLoaderOnConfirm: true, preConfirm: () => serverCall('processDeleteFinanceRecord', financeId, vendorId).catch(error => Swal.showValidationMessage(`เกิดข้อผิดพลาด: ${error.message}`)), allowOutsideClick: () => !Swal.isLoading() }).then(result => { if (result.isConfirmed && result.value.success) { showToast(result.value.message, true); renderFinanceTable(result.value.financeData); } else if (result.value) { showToast(result.value.message, false); } }); };
        window.prepareAddProjectModal = function() { const vendorId = $('#vendorId').val(); if (!vendorId) { showToast('กรุณาบันทึกข้อมูล Vendor หลักก่อน', false); return; } $('#projectForm')[0].reset(); $('#projectId').val(''); $('#projectVendorId').val(vendorId); $('#projectModalLabel').text('เพิ่มโครงการอ้างอิง'); toggleProjectOwnerInput(); $('#projectPackageIds').val(null).trigger('change'); $('#projectModal').modal('show'); };
        window.prepareEditProjectModal = function(p) { $('#projectForm')[0].reset(); $('#projectModalLabel').text('แก้ไขโครงการอ้างอิง'); $('#projectId').val(p.Id); $('#projectVendorId').val(p.VendorId); $('#projectName').val(p.ProjectName); $('#projectYear').val(p.ProjectYear); $('#contractValue').val(p.ContractValue); $('#projectDescription').val(p.ProjectDescription); $('#projectTypeId').val(p.ProjectTypeId || ''); if(p.ProjectOwnerId && p.ProjectOwnerId !== 'other'){ $('#projectOwnerId').val(p.ProjectOwnerId); } else { $('#projectOwnerId').val('other'); $('#projectOwnerCustom').val(p.ProjectOwnerCustom || ''); } toggleProjectOwnerInput(); const packageSelect = $('#projectPackageIds'); const selectedIds = (p.PackageIds && typeof p.PackageIds === 'string') ? p.PackageIds.split(',') : []; packageSelect.val(selectedIds).trigger('change'); $('#projectModal').modal('show'); };
        window.handleDeleteProject = function(projectId, vendorId) { Swal.fire({ title: 'ยืนยันการลบ', text: "คุณต้องการลบโครงการนี้ใช่หรือไม่?", icon: 'warning', showCancelButton: true, confirmButtonColor: '#d33', confirmButtonText: 'ใช่, ลบเลย!', cancelButtonText: 'ยกเลิก', showLoaderOnConfirm: true, preConfirm: () => serverCall('processDeleteProject', projectId, vendorId).catch(error => Swal.showValidationMessage(`เกิดข้อผิดพลาด: ${error.message}`)), allowOutsideClick: () => !Swal.isLoading() }).then(result => { if (result.isConfirmed && result.value.success) { showToast(result.value.message, true); renderProjectsTable(result.value.projects); } else if (result.value) { showToast(result.value.message, false); } }); };

        // ==================== DATA FETCHING & RENDERING (Local Helpers) ====================
        function fetchAndRenderVendors() { const tableBody = $('#vendor-table-body'); tableBody.html(`<tr><td colspan="6" class="text-center"><div class="spinner-border spinner-border-sm"></div> กำลังโหลด...</td></tr>`); const options = { page: currentPage, limit: 10, searchTerm: searchTerm, statusId: selectedStatusId, packageId: selectedPackageId, sortColumn: sortState.column, sortDirection: sortState.direction }; serverCall('getPaginatedVendors', options).then(response => { if (response.success) { renderVendorTable(response.vendors); renderPagination(response); } else { handleServerError({ message: response.message }); } }).catch(handleServerError); }
        function renderVendorTable(vendors) { const tableBody = $('#vendor-table-body'); tableBody.empty(); if (!vendors || vendors.length === 0) { tableBody.html(`<tr><td colspan="6" class="text-center text-muted">ไม่พบข้อมูล Vendor</td></tr>`); return; } $.each(vendors, (index, vendor) => { const statusBadge = `<span class="badge ${vendor.StatusColor||'badge-light'}">${vendor.StatusName||'N/A'}</span>`; const packageIds = vendor.PackageId ? String(vendor.PackageId).split(',') : []; const packageBadges = packageIds.map(id => `<span class="badge badge-info mr-1">${id.trim()}</span>`).join(' '); const row = `<tr><td>${vendor.NameThai}</td><td>${vendor.NameEnglish||'-'}</td><td>${packageBadges||'-'}</td><td>${statusBadge}</td><td>${vendor.Remark||'-'}</td><td><button type="button" class="btn btn-sm btn-warning" onclick="prepareEditVendorModal('${vendor.Id}')" title="แก้ไข"><i class="fas fa-edit"></i></button> <button type="button" class="btn btn-sm btn-danger" onclick="handleDeleteVendor('${vendor.Id}')" title="ลบ"><i class="fas fa-trash-alt"></i></button></td></tr>`; tableBody.append(row); }); }
        function renderPagination(data) { currentPage = data.currentPage; totalPages = data.totalPages; $('#pageInfo').text(`หน้า ${currentPage} จาก ${totalPages} (ทั้งหมด ${data.totalRecords} รายการ)`); const paginationControls = $('#pagination-controls'); paginationControls.empty(); const prevLi = $(`<li class="page-item ${currentPage<=1?'disabled':''}"><a class="page-link" href="#">ก่อนหน้า</a></li>`); prevLi.on('click', (e) => { e.preventDefault(); if (currentPage > 1) { currentPage--; fetchAndRenderVendors(); } }); paginationControls.append(prevLi); const nextLi = $(`<li class="page-item ${currentPage>=totalPages?'disabled':''}"><a class="page-link" href="#">ถัดไป</a></li>`); nextLi.on('click', (e) => { e.preventDefault(); if (currentPage < totalPages) { currentPage++; fetchAndRenderVendors(); } }); paginationControls.append(nextLi); }
        function populateStatusFilter() { serverCall('getAllVendorStatuses').then(statuses => { const select = $('#statusFilter'); select.find('option:gt(0)').remove(); $.each(statuses, (i, stat) => { select.append($('<option>', { value: stat.Id, text: stat.Name })); }); }).catch(handleServerError); }
        function populatePackageFilter() { serverCall('getAllPackagesForSelection').then(packages => { const select = $('#packageFilter'); select.find('option:gt(0)').remove(); $.each(packages, (i, pkg) => { select.append($('<option>', { value: pkg.Id, text: pkg.NameThai })); }); }).catch(handleServerError); }
        function renderContactsTable(contacts) { const tableBody = $('#vendor-contacts-table-body'); tableBody.empty(); if (!contacts || contacts.length === 0) { tableBody.html(`<tr><td colspan="5" class="text-center text-muted">ยังไม่มีข้อมูลผู้ติดต่อ</td></tr>`); return; } $.each(contacts, (i, contact) => { const contactJsonString = JSON.stringify(contact).replace(/"/g, '&quot;').replace(/'/g, '&#39;'); const row = `<tr><td>${contact.Name||'-'}</td><td>${contact.Position||'-'}</td><td>${contact.PhoneNumber||'-'}</td><td>${contact.Email||'-'}</td><td><button type="button" class="btn btn-xs btn-outline-warning" title="แก้ไข" onclick='prepareEditContactModal(${contactJsonString})'><i class="fas fa-edit"></i></button> <button type="button" class="btn btn-xs btn-outline-danger" title="ลบ" onclick="handleDeleteContact('${contact.Id}','${contact.VendorId}')"><i class="fas fa-trash-alt"></i></button></td></tr>`; tableBody.append(row); }); }
        function renderBoardMembersTable(members) { const tableBody = $('#vendor-board-table-body'); tableBody.empty(); if (!members || members.length === 0) { tableBody.html(`<tr><td colspan="3" class="text-center text-muted">ยังไม่มีข้อมูลกรรมการ</td></tr>`); return; } $.each(members, (i, member) => { const memberJsonString = JSON.stringify(member).replace(/"/g, '&quot;').replace(/'/g, '&#39;'); const row = `<tr><td>${member.Name||'-'}</td><td>${member.Surname||'-'}</td><td><button type="button" class="btn btn-xs btn-outline-warning" title="แก้ไข" onclick='prepareEditBoardMemberModal(${memberJsonString})'><i class="fas fa-edit"></i></button> <button type="button" class="btn btn-xs btn-outline-danger" title="ลบ" onclick="handleDeleteBoardMember('${member.Id}','${member.VendorId}')"><i class="fas fa-trash-alt"></i></button></td></tr>`; tableBody.append(row); }); }
        function renderFinanceTable(financeRecords) { const tableBody = $('#vendor-finance-table-body'); tableBody.empty(); if (!financeRecords || financeRecords.length === 0) { tableBody.html(`<tr><td colspan="7" class="text-center text-muted">ยังไม่มีข้อมูลงบการเงิน</td></tr>`); return; } $.each(financeRecords, (i, rec) => { const fileLink = rec.FinancialStatementFileId ? `<a href="https://drive.google.com/file/d/${rec.FinancialStatementFileId}/view" target="_blank"><i class="fas fa-file-alt"></i></a>` : '-'; const row = `<tr><td>${rec.Year||'-'}</td><td>${rec.Revenue?Number(rec.Revenue).toLocaleString():'-'}</td><td>${rec.CurrentAssets?Number(rec.CurrentAssets).toLocaleString():'-'}</td><td>${rec.CurrentLiabilities?Number(rec.CurrentLiabilities).toLocaleString():'-'}</td><td>${rec.TotalLiabilities?Number(rec.TotalLiabilities).toLocaleString():'-'}</td><td class="text-center">${fileLink}</td><td><button type="button" class="btn btn-xs btn-outline-warning" title="แก้ไข" onclick="prepareEditFinanceModal('${rec.Id}')"><i class="fas fa-edit"></i></button> <button type="button" class="btn btn-xs btn-outline-danger" title="ลบ" onclick="handleDeleteFinanceRecord('${rec.Id}','${rec.VendorId}')"><i class="fas fa-trash-alt"></i></button></td></tr>`; tableBody.append(row); }); }
        function renderProjectsTable(projects) { const tableBody = $('#vendor-projects-table-body'); tableBody.empty(); if (!projects || projects.length === 0) { tableBody.html(`<tr><td colspan="5" class="text-center text-muted">ยังไม่มีโครงการอ้างอิง</td></tr>`); return; } $.each(projects, (i, p) => { const fileLink = p.ProjectFileId ? `<a href="https://drive.google.com/file/d/${p.ProjectFileId}/view" target="_blank"><i class="fas fa-file-alt"></i></a>` : '-'; const projectJsonString = JSON.stringify(p).replace(/"/g, '&quot;').replace(/'/g, '&#39;'); const row = `<tr><td>${p.ProjectYear}</td><td>${p.ProjectName}</td><td>${p.ContractValue?Number(p.ContractValue).toLocaleString():'-'}</td><td class="text-center">${fileLink}</td><td><button type="button" class="btn btn-xs btn-outline-warning" title="แก้ไข" onclick='prepareEditProjectModal(${projectJsonString})'><i class="fas fa-edit"></i></button> <button type="button" class="btn btn-xs btn-outline-danger" title="ลบ" onclick="handleDeleteProject('${p.Id}','${p.VendorId}')"><i class="fas fa-trash-alt"></i></button></td></tr>`; tableBody.append(row); }); }
        
        // ==================== FORM & MODAL LOGIC (Local Helpers) ====================
        function loadInitialDataForModal() { return Promise.all([ (availablePackages.length === 0 ? loadPackagesIntoSelect() : Promise.resolve()), (availableStatuses.length === 0 ? loadStatusesIntoSelect() : Promise.resolve()), (availableProjectTypes.length === 0 ? loadProjectTypesForModal() : Promise.resolve()), (availableProjectOwners.length === 0 ? loadProjectOwnersForModal() : Promise.resolve()) ]); }
        function loadPackagesIntoSelect() { return serverCall('getAllPackagesForSelection').then(packages => { availablePackages = packages; const selects = [$('#packageIds'), $('#projectPackageIds')]; $.each(selects, (i, select) => { if(select.length) { if (select.data('select2')) { select.select2('destroy'); } select.empty(); $.each(packages, (j, pkg) => { const displayText = pkg.NameEnglish ? `${pkg.NameThai} | ${pkg.NameEnglish}` : pkg.NameThai; select.append(new Option(displayText, pkg.Id)); }); select.select2({ theme: "bootstrap4", dropdownParent: $(select).closest('.modal'), width: '100%' }); } }); }).catch(handleServerError); }
        function loadStatusesIntoSelect() { return serverCall('getAllVendorStatuses').then(statuses => { availableStatuses = statuses; const select = $('#status'); select.empty(); $.each(statuses, (i, stat) => { select.append($('<option>', { value: stat.Id, text: stat.Name })); }); }).catch(handleServerError); }
        function loadProjectTypesForModal() { return serverCall('getAllProjectTypes').then(data => { availableProjectTypes = data; const select = $('#projectTypeId'); select.html('<option value="">-- กรุณาเลือก --</option>'); $.each(data, (i, item) => { select.append($('<option>', { value: item.Id, text: item.Name })); }); }).catch(handleServerError); }
        function loadProjectOwnersForModal() { return serverCall('getAllProjectOwners').then(data => { availableProjectOwners = data; const select = $('#projectOwnerId'); select.find('option:not([value=""], [value="other"])').remove(); $.each(data, (i, item) => { $(`<option value="${item.Id}">${item.Name}</option>`).insertBefore(select.find('option[value="other"]')); }); }).catch(handleServerError); }
        function populateForm(data) { $('#vendorForm')[0].reset(); $('#vendorId').val(data.Id); $('#nameThai').val(data.NameThai); $('#nameEnglish').val(data.NameEnglish || ''); $('#status').val(data.StatusId); $('#remark').val(data.Remark || ''); $('#companyType').val(data.CompanyType); $('#registeredCapital').val(data.RegisteredCapital || ''); $('#registeredDate').val(data.RegisteredDate ? new Date(data.RegisteredDate).toISOString().split('T')[0] : ''); $('#registeredObject').val(data.RegisteredObject || ''); const packageIds = (data.PackageId && !Array.isArray(data.PackageId)) ? String(data.PackageId).split(',') : (data.PackageId || []); $('#packageIds').val(packageIds).trigger('change'); const folderLink = $('#vendor-folder-link'); if (data.FolderId) { folderLink.attr('href', `https://drive.google.com/drive/folders/${data.FolderId}`).show(); } else { folderLink.hide(); } toggleFileSections(); }
        async function handleSaveVendor() { const saveButton = $('#saveVendorButton'); const form = $('#vendorForm')[0]; const packageSelect = $('#packageIds'); if (!packageSelect.val() || packageSelect.val().length === 0) { showToast('กรุณาเลือกประเภทพัสดุอย่างน้อย 1 รายการ', false); return; } if (!form.checkValidity()) { form.reportValidity(); showToast('กรุณากรอกข้อมูลที่จำเป็นให้ครบถ้วน', false); return; } setLoading(saveButton[0], true); try { const formData = { Id: $('#vendorId').val(), NameThai: $('#nameThai').val(), NameEnglish: $('#nameEnglish').val(), PackageId: $('#packageIds').val(), StatusId: $('#status').val(), Remark: $('#remark').val(), CompanyType: $('#companyType').val(), RegisteredCapital: $('#registeredCapital').val(), RegisteredDate: $('#registeredDate').val(), RegisteredObject: $('#registeredObject').val() }; const fileInputs = $('#files input[type="file"]'); const filePromises = []; const fileData = {}; $.each(fileInputs, (i, input) => { if (input.files.length > 0) { const file = input.files[0]; const promise = new Promise((resolve, reject) => { const reader = new FileReader(); reader.onload = (e) => { fileData[input.id] = { fileName: file.name, mimeType: file.type, base64: e.target.result.split(',')[1] }; resolve(); }; reader.onerror = reject; reader.readAsDataURL(file); }); filePromises.push(promise); } }); await Promise.all(filePromises); const response = await serverCall('processAddOrEditVendor', formData, fileData); if (response.success) { showToast(response.message, true); $('#vendorModal').modal('hide'); fetchAndRenderVendors(); } else { showToast(response.message, false); } } catch (err) { handleServerError(err); } finally { setLoading(saveButton[0], false); } }
        async function handleSaveContact() { const form = $('#contactForm')[0]; if (!form.checkValidity()) { form.reportValidity(); return; } const saveButton = $('#saveContactButton'); setLoading(saveButton[0], true); const formData = { Id: $('#contactId').val(), VendorId: $('#contactVendorId').val(), Name: $('#contactName').val(), Position: $('#contactPosition').val(), Email: $('#contactEmail').val(), PhoneNumber: "'" + $('#contactPhoneNumber').val(), LineId: $('#contactLineId').val(), }; try { const response = await serverCall('processAddOrEditContact', formData); if (response.success) { showToast(response.message, true); renderContactsTable(response.contacts); $('#contactModal').modal('hide'); } else { showToast(response.message, false); } } catch (err) { handleServerError(err); } finally { setLoading(saveButton[0], false); } }
        async function handleSaveBoardMember() { const form = $('#boardMemberForm')[0]; if (!form.checkValidity()) { form.reportValidity(); return; } const saveButton = $('#saveBoardMemberButton'); setLoading(saveButton[0], true); const formData = { Id: $('#boardMemberId').val(), VendorId: $('#boardMemberVendorId').val(), Name: $('#boardMemberName').val(), Surname: $('#boardMemberSurname').val(), }; try { const response = await serverCall('processAddOrEditBoardMember', formData); if (response.success) { showToast(response.message, true); renderBoardMembersTable(response.members); $('#boardMemberModal').modal('hide'); } else { showToast(response.message, false); } } catch (err) { handleServerError(err); } finally { setLoading(saveButton[0], false); } }
        async function handleSaveFinanceRecord() { const form = $('#financeForm')[0]; if (!form.checkValidity()) { form.reportValidity(); return; } const saveButton = $('#saveFinanceButton'); setLoading(saveButton[0], true); const formData = { Id: $('#financeId').val(), VendorId: $('#financeVendorId').val(), Year: $('#financeYear').val(), Revenue: $('#financeRevenue').val(), CurrentAssets: $('#financeCurrentAssets').val(), CurrentLiabilities: $('#financeCurrentLiabilities').val(), TotalLiabilities: $('#financeTotalLiabilities').val(), }; const fileInput = $('#financialStatementFile')[0]; let fileData = {}; if (fileInput.files.length > 0) { const file = fileInput.files[0]; try { const base64 = await new Promise((resolve, reject) => { const reader = new FileReader(); reader.onload = e => resolve(e.target.result.split(',')[1]); reader.onerror = reject; reader.readAsDataURL(file); }); fileData['financialStatementFile'] = { fileName: file.name, mimeType: file.type, base64: base64 }; } catch (err) { handleServerError({ message: 'ไม่สามารถอ่านไฟล์ได้' }); setLoading(saveButton[0], false); return; } } try { const response = await serverCall('processAddOrEditFinanceRecord', formData, fileData); if (response.success) { showToast(response.message, true); renderFinanceTable(response.financeData); $('#financeModal').modal('hide'); } else { showToast(response.message, false); } } catch (err) { handleServerError(err); } finally { setLoading(saveButton[0], false); } }
        async function handleSaveProject() { const form = $('#projectForm')[0]; if (!form.checkValidity()) { form.reportValidity(); return; } if ($('#projectOwnerId').val() === 'other' && !$('#projectOwnerCustom').val()) { showToast('กรุณาระบุชื่อเจ้าของโครงการ', false); return;} const saveButton = $('#saveProjectButton'); setLoading(saveButton[0], true); const formData = { Id: $('#projectId').val(), VendorId: $('#projectVendorId').val(), ProjectName: $('#projectName').val(), ProjectYear: $('#projectYear').val(), ContractValue: $('#contractValue').val(), ProjectDescription: $('#projectDescription').val(), ProjectTypeId: $('#projectTypeId').val(), ProjectOwnerId: $('#projectOwnerId').val(), ProjectOwnerCustom: $('#projectOwnerCustom').val(), PackageIds: $('#projectPackageIds').val(), }; const fileInput = $('#projectFile')[0]; let fileData = {}; if (fileInput.files.length > 0) { const file = fileInput.files[0]; try { const base64 = await new Promise((resolve, reject) => { const reader = new FileReader(); reader.onload = e => resolve(e.target.result.split(',')[1]); reader.onerror = reject; reader.readAsDataURL(file); }); fileData['projectFile'] = { fileName: file.name, mimeType: file.type, base64: base64 }; } catch (err) { handleServerError({ message: 'ไม่สามารถอ่านไฟล์ได้' }); setLoading(saveButton[0], false); return; } } try { const response = await serverCall('processAddOrEditProject', formData, fileData); if (response.success) { showToast(response.message, true); renderProjectsTable(response.projects); $('#projectModal').modal('hide'); } else { showToast(response.message, false); } } catch (err) { handleServerError(err); } finally { setLoading(saveButton[0], false); } };
        
        // --- UI HELPERS ---
        function updateSortIcons() { $('th[data-column]').each(function() { const icon = $(this).find('i'); const columnOfHeader = $(this).data('column'); icon.removeClass('fa-sort-up fa-sort-down').addClass('fa-sort'); if (sortState.column === columnOfHeader) { if (sortState.direction === 'asc') { icon.removeClass('fa-sort').addClass('fa-sort-up'); } else if (sortState.direction === 'desc') { icon.removeClass('fa-sort').addClass('fa-sort-down'); } } }); }
        function toggleFileSections() { const isJuristic = $('#companyType').val() === 'Juristic Person'; $('#juristic-files').toggle(isJuristic); $('#individual-files').toggle(!isJuristic); }
        function toggleProjectOwnerInput() { const ownerSelect = $('#projectOwnerId'); const customGroup = $('#projectOwnerCustomGroup'); const customInput = $('#projectOwnerCustom'); if (ownerSelect.val() === 'other') { customGroup.show(); customInput.prop('required', true); } else { customGroup.hide(); customInput.prop('required', false).val(''); } }
        function setModalLoading(isLoading) { $('#modal-loader').toggle(isLoading); $('#vendorForm').toggle(!isLoading); $('#saveVendorButton').prop('disabled', isLoading); }
        function setFinanceModalLoading(isLoading) { $('#finance-modal-loader').toggle(isLoading); $('#financeForm').toggle(!isLoading); $('#saveFinanceButton').prop('disabled', isLoading); }
        
    });
</script>