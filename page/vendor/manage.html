<!-- file: page/vendor/manage.html -->


<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
    <h1 class="h2"><i class="fas fa-hands-helping"></i> <?= data.title ?></h1>
    <div class="btn-toolbar mb-2 mb-md-0">
        <button type="button" class="btn btn-sm btn-outline-success" onclick="prepareAddVendorModal()">
            <i class="fas fa-plus"></i> เพิ่ม Vendor ใหม่
        </button>
    </div>
</div>

<?!= include('page/vendor/manage_list.html') ?>

<?!= include('page/vendor/manage_modal.html') ?>

<script>

  // ==================== CONSTANTS ====================
  // [FIX] อ่านค่า baseUrl จาก data-attribute ของ body ซึ่งเป็นวิธีที่ปลอดภัยและถูกต้อง
  const VENDOR_BASE_URL = document.body.dataset.baseUrl;

  // ==================== GLOBAL STATE ====================
  let availablePackages = [], availableStatuses = [], availableProjectTypes = [], availableProjectOwners = [], availableCompanyTypes = [];
  let currentPage = 1, totalPages = 1;
  let searchTerm = '', selectedStatusId = '', selectedPackageId = '';
  let sortState = { column: 'Id', direction: 'desc' };
  let debounceTimer;

  // ==================== INITIALIZATION (Entry Point) ====================
  document.addEventListener('DOMContentLoaded', function () {
      fetchAndRenderVendors();
      populateStatusFilter();
      populatePackageFilter();

      document.getElementById('saveVendorButton').addEventListener('click', handleSaveVendor);
      document.getElementById('saveContactButton').addEventListener('click', handleSaveContact);
      document.getElementById('saveBoardMemberButton').addEventListener('click', handleSaveBoardMember);
      document.getElementById('saveFinanceButton').addEventListener('click', handleSaveFinanceRecord);
      document.getElementById('saveProjectButton').addEventListener('click', handleSaveProject);
      document.getElementById('addNewProjectOwnerBtn').addEventListener('click', prepareAddProjectOwnerSubModal);
      document.getElementById('saveNewProjectOwnerBtn').addEventListener('click', handleSaveNewProjectOwner);
      document.getElementById('projectOwnerId').addEventListener('change', toggleProjectOwnerInput);
      document.getElementById('searchInput').addEventListener('input', () => { clearTimeout(debounceTimer); debounceTimer = setTimeout(() => { searchTerm = document.getElementById('searchInput').value; currentPage = 1; fetchAndRenderVendors(); }, 500); });
      document.getElementById('statusFilter').addEventListener('change', () => { selectedStatusId = document.getElementById('statusFilter').value; currentPage = 1; fetchAndRenderVendors(); });
      
      $('#packageFilter').on('change', function() {
          selectedPackageId = $(this).val(); 
          currentPage = 1;
          fetchAndRenderVendors();
      });
      
      document.querySelectorAll('th[data-column]').forEach(header => { header.addEventListener('click', () => { const column = header.dataset.column; if (sortState.column === column) { sortState.direction = sortState.direction === 'asc' ? 'desc' : 'asc'; } else { sortState.column = column; sortState.direction = 'asc'; } updateSortIcons(); fetchAndRenderVendors(); }); });
  });

  // ==================== MODAL PREPARATION ====================
  window.prepareAddVendorModal = function () {
    if ($('#packageIds').data('select2')) $('#packageIds').select2('destroy');
    document.getElementById('vendorForm').reset();
    document.getElementById('vendorId').value = '';
    $('#vendorModalLabel').text('เพิ่มข้อมูล Vendor ใหม่');
    
    renderContactsTable([]);
    renderBoardMembersTable([]);
    renderFinanceTable([]);
    renderProjectsTable([]);
    
    // รีเซ็ตการแสดงผลไฟล์แนบ
    const fileFields = ['companyProfileFile', 'idCardFile', 'companyCertFile', 'vatCertFile', 'bookBankFile'];
    fileFields.forEach(field => {
        document.getElementById(`${field}LinkContainer`).style.display = 'none';
        document.getElementById(`no${field.charAt(0).toUpperCase() + field.slice(1)}`).style.display = 'inline';
    });
    
    loadInitialDataForModal();
    
    $('#packageIds').select2({ theme: 'bootstrap4', placeholder: 'ค้นหาและเลือกประเภทพัสดุ', allowClear: true, dropdownParent: $('#vendorModal') });
    
    $('#vendorTab a:first').tab('show');
    document.getElementById('vendor-folder-link').style.display = 'none';

    document.querySelectorAll('.related-data-tab').forEach(el => el.style.display = 'none');
    document.getElementById('addContactBtn').disabled = true;
    document.getElementById('addBoardMemberBtn').disabled = true;
    document.getElementById('addFinanceBtn').disabled = true;
    document.getElementById('addProjectBtn').disabled = true;

    setModalLoading(false);
    $('#vendorModal').modal('show');
  };

  window.prepareEditVendorModal = function (vendorId) {
    if ($('#packageIds').data('select2')) $('#packageIds').select2('destroy');
    
    document.querySelectorAll('.related-data-tab').forEach(el => el.style.display = 'block');
    document.getElementById('addContactBtn').disabled = false;
    document.getElementById('addBoardMemberBtn').disabled = false;
    document.getElementById('addFinanceBtn').disabled = false;
    document.getElementById('addProjectBtn').disabled = false;

    $('#vendorModalLabel').text('แก้ไขข้อมูล Vendor');
    setModalLoading(true);
    $('#vendorTab a:first').tab('show');
    $('#vendorModal').modal('show');

    Promise.all([
      loadInitialDataForModal(),
      serverCall('getVendorDetailsById', vendorId),
      serverCall('getContactsByVendorId', vendorId),
      serverCall('getBoardMembersByVendorId', vendorId),
      serverCall('getFinanceByVendorId', vendorId),
      serverCall('getProjectsByVendorId', vendorId)
    ]).then(([, vendorData, contactsData, boardData, financeData, projectsData]) => {
      if (!vendorData) { showToast('ไม่พบข้อมูล Vendor', false); $('#vendorModal').modal('hide'); return; }
      
      populateForm(vendorData); 
      renderContactsTable(contactsData);
      renderBoardMembersTable(boardData);
      renderFinanceTable(financeData);
      renderProjectsTable(projectsData);

      $('#packageIds').select2({ theme: 'bootstrap4', placeholder: 'ค้นหาและเลือกประเภทพัสดุ', allowClear: true, dropdownParent: $('#vendorModal') });
      
      if (vendorData.PackageId && Array.isArray(vendorData.PackageId)) {
        $('#packageIds').val(vendorData.PackageId).trigger('change');
      }
      setModalLoading(false);
    }).catch(err => {
      handleServerError(err);
      $('#vendorModal').modal('hide');
    });
  };


  window.handleDeleteVendor = function (vendorId) {
    Swal.fire({ title: 'ยืนยันการลบ', text: `คุณกำลังจะลบข้อมูล Vendor (ID: ${vendorId}) พร้อมไฟล์ทั้งหมด`, icon: 'warning', showCancelButton: true, confirmButtonColor: '#d33', confirmButtonText: 'ใช่, ลบเลย!', cancelButtonText: 'ยกเลิก', showLoaderOnConfirm: true, preConfirm: () => serverCall('processDeleteVendor', vendorId).catch(error => Swal.showValidationMessage(`เกิดข้อผิดพลาด: ${error.message}`)), allowOutsideClick: () => !Swal.isLoading() }).then(result => { if (result.isConfirmed && result.value.success) { Swal.fire('ลบสำเร็จ!', result.value.message, 'success'); fetchAndRenderVendors(); } else if (result.value) { Swal.fire('เกิดข้อผิดพลาด!', result.value.message, 'error'); } });
  };

  // CONTACT
  window.prepareAddContactModal = function () { const currentVendorId = document.getElementById('vendorId').value; if (!currentVendorId) { showToast('กรุณาบันทึกข้อมูล Vendor หลักก่อน', false); return; } document.getElementById('contactForm').reset(); document.getElementById('contactId').value = ''; document.getElementById('contactVendorId').value = currentVendorId; $('#contactModalLabel').text('เพิ่มข้อมูลผู้ติดต่อ'); $('#contactModal').modal('show'); };
  window.prepareEditContactModal = function (contactData) { document.getElementById('contactForm').reset(); $('#contactModalLabel').text('แก้ไขข้อมูลผู้ติดต่อ'); document.getElementById('contactId').value = contactData.Id; document.getElementById('contactVendorId').value = contactData.VendorId; document.getElementById('contactName').value = contactData.Name || ''; document.getElementById('contactPosition').value = contactData.Position || ''; document.getElementById('contactEmail').value = contactData.Email || ''; document.getElementById('contactPhoneNumber').value = contactData.PhoneNumber ? String(contactData.PhoneNumber).replace(/'/g, '') : ''; document.getElementById('contactLineId').value = contactData.LineId || ''; $('#contactModal').modal('show'); };
  window.handleDeleteContact = function (contactId, vendorId) {
    Swal.fire({
      title: 'ยืนยันการลบ',
      text: "คุณต้องการลบผู้ติดต่อรายนี้ใช่หรือไม่?",
      icon: 'warning',
      showCancelButton: true,
      confirmButtonColor: '#d33',
      confirmButtonText: 'ใช่, ลบเลย',
      cancelButtonText: 'ยกเลิก',
      showLoaderOnConfirm: true,
      preConfirm: () => {
        return serverCall('processDeleteContact', contactId, vendorId)
          .catch(error => Swal.showValidationMessage(`เกิดข้อผิดพลาด: ${error.message}`));
      },
      allowOutsideClick: () => !Swal.isLoading()
    }).then((result) => {
      if (result.isConfirmed && result.value.success) {
        showToast(result.value.message, true);
        renderContactsTable(result.value.data);
      } else if (result.value) {
        showToast(result.value.message, false);
      }
    });
  };

  window.prepareAddBoardMemberModal = function () { const currentVendorId = document.getElementById('vendorId').value; if (!currentVendorId) { showToast('กรุณาบันทึกข้อมูล Vendor หลักก่อน', false); return; } document.getElementById('boardMemberForm').reset(); document.getElementById('boardMemberId').value = ''; document.getElementById('boardMemberVendorId').value = currentVendorId; $('#boardMemberModalLabel').text('เพิ่มข้อมูลกรรมการ'); $('#boardMemberModal').modal('show'); };
  window.prepareEditBoardMemberModal = function (memberData) { document.getElementById('boardMemberForm').reset(); $('#boardMemberModalLabel').text('แก้ไขข้อมูลกรรมการ'); document.getElementById('boardMemberId').value = memberData.Id; document.getElementById('boardMemberVendorId').value = memberData.VendorId; document.getElementById('boardMemberName').value = memberData.Name || ''; document.getElementById('boardMemberSurname').value = memberData.Surname || ''; $('#boardMemberModal').modal('show'); };
  window.handleDeleteBoardMember = function (memberId, vendorId) {
    Swal.fire({
      title: 'ยืนยันการลบ',
      text: "คุณต้องการลบข้อมูลกรรมการท่านนี้ใช่หรือไม่?",
      icon: 'warning',
      showCancelButton: true,
      confirmButtonColor: '#d33',
      confirmButtonText: 'ใช่, ลบเลย',
      cancelButtonText: 'ยกเลิก',
      showLoaderOnConfirm: true,
      preConfirm: () => {
        return serverCall('processDeleteBoardMember', memberId, vendorId)
          .catch(error => Swal.showValidationMessage(`เกิดข้อผิดพลาด: ${error.message}`));
      },
      allowOutsideClick: () => !Swal.isLoading()
    }).then((result) => {
      if (result.isConfirmed && result.value.success) {
        showToast(result.value.message, true);
        renderBoardMembersTable(result.value.data);
      } else if (result.value) {
        showToast(result.value.message, false);
      }
    });
  };

  window.prepareAddFinanceModal = function () { const currentVendorId = document.getElementById('vendorId').value; if (!currentVendorId) { showToast('กรุณาบันทึกข้อมูล Vendor หลักก่อน', false); return; } document.getElementById('financeForm').reset(); document.getElementById('financeId').value = ''; document.getElementById('financeVendorId').value = currentVendorId; $('#financeModalLabel').text('เพิ่มข้อมูลงบการเงิน'); setFinanceModalLoading(false); $('#financeModal').modal('show'); };
  window.prepareEditFinanceModal = function (financeId) { $('#financeModalLabel').text('แก้ไขข้อมูลงบการเงิน'); setFinanceModalLoading(true); $('#financeModal').modal('show'); serverCall('getFinanceRecordById', financeId).then(recordData => { if (!recordData) { showToast('ไม่สามารถดึงข้อมูลได้', false); $('#financeModal').modal('hide'); return; } document.getElementById('financeForm').reset(); document.getElementById('financeId').value = recordData.Id; document.getElementById('financeVendorId').value = recordData.VendorId; document.getElementById('financeYear').value = recordData.Year || ''; document.getElementById('financeRevenue').value = recordData.Revenue || ''; document.getElementById('financeCurrentAssets').value = recordData.CurrentAssets || ''; document.getElementById('financeCurrentLiabilities').value = recordData.CurrentLiabilities || ''; document.getElementById('financeTotalLiabilities').value = recordData.TotalLiabilities || ''; setFinanceModalLoading(false); }).catch(err => { handleServerError(err); $('#financeModal').modal('hide'); }); };
  window.handleDeleteFinanceRecord = function (financeId, vendorId) {
    Swal.fire({
      title: 'ยืนยันการลบ',
      text: "คุณต้องการลบข้อมูลงบการเงินรายการนี้ใช่หรือไม่?",
      icon: 'warning',
      showCancelButton: true,
      confirmButtonColor: '#d33',
      confirmButtonText: 'ใช่, ลบเลย',
      cancelButtonText: 'ยกเลิก',
      showLoaderOnConfirm: true,
      preConfirm: () => {
        return serverCall('processDeleteFinanceRecord', financeId, vendorId)
          .catch(error => Swal.showValidationMessage(`เกิดข้อผิดพลาด: ${error.message}`));
      },
      allowOutsideClick: () => !Swal.isLoading()
    }).then((result) => {
      if (result.isConfirmed && result.value.success) {
        showToast(result.value.message, true);
        renderFinanceTable(result.value.data); // อัปเดตตาราง
      } else if (result.value) {
        showToast(result.value.message, false);
      }
    });
  };

 window.prepareAddProjectModal = function () { 
    const vendorId = document.getElementById('vendorId').value; 
    if (!vendorId) { 
      showToast('กรุณาบันทึกข้อมูล Vendor หลักก่อน', false); 
      return; 
    } 
    document.getElementById('projectForm').reset(); 
    document.getElementById('projectId').value = ''; 
    document.getElementById('projectVendorId').value = vendorId; 
    $('#projectModalLabel').text('เพิ่มโครงการอ้างอิง'); 
    
    // [1] ทำลาย Select2 instance เก่า (ถ้ามี) เพื่อป้องกัน error
    // ทำพร้อมกันทั้ง 2 dropdown เลย
    if ($('#projectPackageIds').data('select2')) {
        $('#projectPackageIds').select2('destroy');
    }
    if ($('#projectOwnerId').data('select2')) { // <-- เพิ่มส่วนนี้
        $('#projectOwnerId').select2('destroy');
    }
    
    toggleProjectOwnerInput(); 
    $('#projectModal').modal('show'); 

    // [2] สร้าง Select2 instance ใหม่
    $('#projectPackageIds').select2({
        theme: 'bootstrap4',
        placeholder: 'ค้นหาและเลือกประเภทงานที่ทำ',
        allowClear: true,
        dropdownParent: $('#projectModal')
    });
    
    $('#projectOwnerId').select2({ // <-- เพิ่มส่วนนี้
        theme: 'bootstrap4',
        dropdownParent: $('#projectModal')
    });
 };

  window.prepareEditProjectModal = function (p) { 
    document.getElementById('projectForm').reset(); 
    $('#projectModalLabel').text('แก้ไขโครงการอ้างอิง'); 
    document.getElementById('projectId').value = p.Id; 
    document.getElementById('projectVendorId').value = p.VendorId; 
    document.getElementById('projectName').value = p.ProjectName; 
    document.getElementById('projectYear').value = p.ProjectYear; 
    document.getElementById('contractValue').value = p.ContractValue; 
    document.getElementById('projectDescription').value = p.ProjectDescription; 
    document.getElementById('projectTypeId').value = p.ProjectTypeId || ''; 
    if (p.ProjectOwnerId && p.ProjectOwnerId !== 'other') { 
      document.getElementById('projectOwnerId').value = p.ProjectOwnerId; 
    } else { 
      document.getElementById('projectOwnerId').value = 'other'; 
      document.getElementById('projectOwnerCustom').value = p.ProjectOwnerCustom || ''; 
    } 
    toggleProjectOwnerInput(); 
    
    // [1] ทำลาย Select2 instance เก่า
    if ($('#projectPackageIds').data('select2')) {
        $('#projectPackageIds').select2('destroy');
    }
    if ($('#projectOwnerId').data('select2')) { // <-- เพิ่มส่วนนี้
        $('#projectOwnerId').select2('destroy');
    }

    $('#projectModal').modal('show'); 

    // [2] สร้าง Select2 instance ใหม่
    $('#projectPackageIds').select2({
        theme: 'bootstrap4',
        placeholder: 'ค้นหาและเลือกประเภทงานที่ทำ',
        allowClear: true,
        dropdownParent: $('#projectModal')
    });

    $('#projectOwnerId').select2({ // <-- เพิ่มส่วนนี้
        theme: 'bootstrap4',
        dropdownParent: $('#projectModal')
    });

    // [3] ตั้งค่าที่ถูกเลือกไว้ด้วย jQuery และสั่ง .trigger('change')
    if (p.PackageIds && typeof p.PackageIds === 'string') { 
        const selectedIds = p.PackageIds.split(',').map(id => id.trim()); 
        $('#projectPackageIds').val(selectedIds).trigger('change'); 
    }
    
    // ตั้งค่าสำหรับ Project Owner dropdown
    const ownerSelectValue = (p.ProjectOwnerId && p.ProjectOwnerId !== 'other') ? p.ProjectOwnerId : 'other';
    $('#projectOwnerId').val(ownerSelectValue).trigger('change'); // <-- เพิ่มส่วนนี้
 };

  window.handleDeleteProject = function (projectId, vendorId) {
    Swal.fire({
      title: 'ยืนยันการลบ',
      text: "คุณต้องการลบโครงการอ้างอิงนี้ใช่หรือไม่?",
      icon: 'warning',
      showCancelButton: true,
      confirmButtonColor: '#d33',
      confirmButtonText: 'ใช่, ลบเลย',
      cancelButtonText: 'ยกเลิก',
      showLoaderOnConfirm: true,
      preConfirm: () => {
        return serverCall('processDeleteProject', projectId, vendorId)
          .catch(error => Swal.showValidationMessage(`เกิดข้อผิดพลาด: ${error.message}`));
      },
      allowOutsideClick: () => !Swal.isLoading()
    }).then((result) => {
      if (result.isConfirmed && result.value.success) {
        showToast(result.value.message, true);
        renderProjectsTable(result.value.data); // อัปเดตตารางโครงการ
      } else if (result.value) {
        showToast(result.value.message, false);
      }
    });
  };

  // ==================== DATA FETCHING & RENDERING ====================
    function fetchAndRenderVendors() { 
        const tableBody = document.getElementById('vendor-table-body'); 
        tableBody.innerHTML = `<tr><td colspan="8" class="text-center"><div class="spinner-border spinner-border-sm"></div> กำลังโหลด...</td></tr>`; 
        const options = { page: currentPage, limit: 10, searchTerm: searchTerm, statusId: selectedStatusId, packageId: selectedPackageId, sortColumn: sortState.column, sortDirection: sortState.direction }; 
        serverCall('getPaginatedVendors', options).then(response => { if (response.success) { renderVendorTable(response.vendors); renderPagination(response); } else { handleServerError({ message: response.message }); } }).catch(handleServerError); 
    }
  
  /**
   * [FIXED] แก้ไขฟังก์ชันให้ใช้ตัวแปร VENDOR_BASE_URL ที่ถูกต้อง
   */
  function renderVendorTable(vendors) {
      const tableBody = document.getElementById('vendor-table-body');
      tableBody.innerHTML = '';
      if (!vendors || vendors.length === 0) {
          tableBody.innerHTML = `<tr><td colspan="8" class="text-center text-muted">ไม่พบข้อมูล Vendor</td></tr>`;
          return;
      }
      vendors.forEach(vendor => {
          const row = tableBody.insertRow();
          const statusBadge = `<span class="badge ${vendor.StatusColor || 'badge-light'}">${vendor.StatusName || 'N/A'}</span>`;
          const packageBadges = (vendor.PackageDisplayNames || []).map(name => `<span class="badge badge-info mr-1">${name}</span>`).join(' ');
          const grade = vendor.LatestGrade || '-';
          const gradeColorMapping = { 'A': 'badge-success', 'B': 'badge-primary', 'C': 'badge-warning', 'D': 'badge-danger' };
          const gradeColor = gradeColorMapping[grade.replace('+', '')] || 'badge-light';
          const gradeBadge = `<span class="badge ${gradeColor}" style="font-size: 0.9em;">${grade}</span>`;
          const relationshipCell = vendor.RelationshipInfo 
              ? `<td><span class="text-warning" data-toggle="tooltip" data-placement="right" title="${escapeHtml(vendor.RelationshipInfo)}"><i class="fas fa-exclamation-triangle"></i></span></td>` 
              : '<td></td>';

          // [นี่คือส่วนที่แก้ไข] เปลี่ยนมาใช้ตัวแปร VENDOR_BASE_URL ที่เราประกาศไว้
          row.innerHTML = `
              ${relationshipCell}
              <td>${vendor.NameThai}</td>
              <td>${vendor.NameEnglish || '-'}</td>
              <td>${packageBadges || '-'}</td>
              <td>${statusBadge}</td>
              <td class="text-center">${gradeBadge}</td>
              <td>${vendor.Remark || '-'}</td>
              <td>
                  <div class="btn-group" role="group">
                      <button type="button" class="btn btn-sm btn-warning" onclick="prepareEditVendorModal('${vendor.Id}')" title="แก้ไขข้อมูลหลัก"><i class="fas fa-edit"></i></button>
                      <a href="${VENDOR_BASE_URL}?page=vendor/pq&vendorId=${vendor.Id}" target="_blank" class="btn btn-sm btn-primary" title="สร้างฟอร์มประเมิน (PQ)"><i class="fas fa-file-alt"></i></a>
                      <a href="${VENDOR_BASE_URL}?page=vendor/history&vendorId=${vendor.Id}" class="btn btn-sm btn-info" title="ดูประวัติการประเมิน"><i class="fas fa-history"></i></a>
                      <button type="button" class="btn btn-sm btn-danger" onclick="handleDeleteVendor('${vendor.Id}')" title="ลบ"><i class="fas fa-trash-alt"></i></button>
                  </div>
              </td>`;
      });
      $('[data-toggle="tooltip"]').tooltip();
  }

  function renderPagination(data) { currentPage = data.currentPage; totalPages = data.totalPages; document.getElementById('pageInfo').textContent = `หน้า ${currentPage} จาก ${totalPages} (ทั้งหมด ${data.totalRecords} รายการ)`; const paginationControls = document.getElementById('pagination-controls'); paginationControls.innerHTML = ''; const prevLi = document.createElement('li'); prevLi.className = `page-item ${currentPage <= 1 ? 'disabled' : ''}`; prevLi.innerHTML = `<a class="page-link" href="#">ก่อนหน้า</a>`; prevLi.addEventListener('click', (e) => { e.preventDefault(); if (currentPage > 1) { currentPage--; fetchAndRenderVendors(); } }); paginationControls.appendChild(prevLi); const nextLi = document.createElement('li'); nextLi.className = `page-item ${currentPage >= totalPages ? 'disabled' : ''}`; nextLi.innerHTML = `<a class="page-link" href="#">ถัดไป</a>`; nextLi.addEventListener('click', (e) => { e.preventDefault(); if (currentPage < totalPages) { currentPage++; fetchAndRenderVendors(); } }); paginationControls.appendChild(nextLi); }
  function populateStatusFilter() { serverCall('getAllVendorStatuses').then(statuses => { const select = document.getElementById('statusFilter'); for (let i = select.options.length - 1; i > 0; i--) { select.remove(i); } statuses.forEach(stat => select.add(new Option(stat.Name, stat.Id))); }).catch(handleServerError); }
  
  function populatePackageFilter() { 
    serverCall('getAllPackagesForSelection').then(packages => { 
      const select = document.getElementById('packageFilter'); 
      for (let i = select.options.length - 1; i > 0; i--) { 
        select.remove(i); 
      } 

      // ใช้ DisplayName ที่ได้จาก Server มาเป็น Text ของ Option
      packages.forEach(pkg => {
          select.add(new Option(pkg.DisplayName, pkg.Id));
      });

      // เรียกใช้งาน Select2 กับ Dropdown ของ Filter
      $('#packageFilter').select2({
          theme: 'bootstrap4',
          placeholder: 'เลือกเพื่อกรองประเภทพัสดุ', // ข้อความที่จะแสดงเมื่อยังไม่ได้เลือก
          allowClear: true // อนุญาตให้ผู้ใช้ลบสิ่งที่เลือก (กลับไปเป็น "ทุกประเภทพัสดุ")
      });

    }).catch(handleServerError); }

  function renderContactsTable(contacts) { const tableBody = document.getElementById('vendor-contacts-table-body'); tableBody.innerHTML = ''; if (!contacts || contacts.length === 0) { tableBody.innerHTML = `<tr><td colspan="5" class="text-center text-muted">ยังไม่มีข้อมูลผู้ติดต่อ</td></tr>`; return; } contacts.forEach(contact => { const row = tableBody.insertRow(); const contactJsonString = JSON.stringify(contact).replace(/"/g, '&quot;'); row.innerHTML = `<td>${contact.Name || '-'}</td><td>${contact.Position || '-'}</td><td>${contact.PhoneNumber || '-'}</td><td>${contact.Email || '-'}</td><td><button type="button" class="btn btn-xs btn-outline-warning" title="แก้ไข" onclick="prepareEditContactModal(${contactJsonString})"><i class="fas fa-edit"></i></button> <button type="button" class="btn btn-xs btn-outline-danger" title="ลบ" onclick="handleDeleteContact('${contact.Id}', '${contact.VendorId}')"><i class="fas fa-trash-alt"></i></button></td>`; }); }
  function renderBoardMembersTable(members) { const tableBody = document.getElementById('vendor-board-table-body'); tableBody.innerHTML = ''; if (!members || members.length === 0) { tableBody.innerHTML = `<tr><td colspan="3" class="text-center text-muted">ยังไม่มีข้อมูลกรรมการ</td></tr>`; return; } members.forEach(member => { const row = tableBody.insertRow(); const memberJsonString = JSON.stringify(member).replace(/"/g, '&quot;'); row.innerHTML = `<td>${member.Name || '-'}</td><td>${member.Surname || '-'}</td><td><button type="button" class="btn btn-xs btn-outline-warning" title="แก้ไข" onclick='prepareEditBoardMemberModal(${memberJsonString})'><i class="fas fa-edit"></i></button> <button type="button" class="btn btn-xs btn-outline-danger" title="ลบ" onclick="handleDeleteBoardMember('${member.Id}', '${member.VendorId}')"><i class="fas fa-trash-alt"></i></button></td>`; }); }
  function renderFinanceTable(financeRecords) {
      const tableBody = document.getElementById('vendor-finance-table-body');
      tableBody.innerHTML = '';
      if (!financeRecords || financeRecords.length === 0) {
          // [แก้ไข] แก้ colspan เป็น 6
          tableBody.innerHTML = `<tr><td colspan="6" class="text-center text-muted">ยังไม่มีข้อมูลงบการเงิน</td></tr>`;
          return;
      }
      financeRecords.forEach(rec => {
          const row = tableBody.insertRow();
          const recordJsonString = JSON.stringify(rec).replace(/"/g, '&quot;');
          
          // [แก้ไข] ลบ fileLink และ <td> ที่เกี่ยวข้องออก
          row.innerHTML = `
              <td>${rec.Year || '-'}</td>
              <td>${rec.Revenue ? Number(rec.Revenue).toLocaleString() : '-'}</td>
              <td>${rec.CurrentAssets ? Number(rec.CurrentAssets).toLocaleString() : '-'}</td>
              <td>${rec.CurrentLiabilities ? Number(rec.CurrentLiabilities).toLocaleString() : '-'}</td>
              <td>${rec.TotalLiabilities ? Number(rec.TotalLiabilities).toLocaleString() : '-'}</td>
              <td>
                  <button type="button" class="btn btn-xs btn-outline-warning" title="แก้ไข" onclick="prepareEditFinanceModal('${rec.Id}')"><i class="fas fa-edit"></i></button> 
                  <button type="button" class="btn btn-xs btn-outline-danger" title="ลบ" onclick="handleDeleteFinanceRecord('${rec.Id}', '${rec.VendorId}')"><i class="fas fa-trash-alt"></i></button>
              </td>
          `;
      });
  }
  function renderProjectsTable(projects) {
      const tableBody = document.getElementById('vendor-projects-table-body');
      tableBody.innerHTML = '';
      if (!projects || projects.length === 0) {
          // แก้ไข colspan ให้ตรงกับจำนวนคอลัมน์ใหม่
          tableBody.innerHTML = `<tr><td colspan="5" class="text-center text-muted">ยังไม่มีโครงการอ้างอิง</td></tr>`;
          return;
      }
      projects.forEach(p => {
          const row = tableBody.insertRow();
          const projectJsonString = JSON.stringify(p).replace(/"/g, '&quot;');
          
          // [ส่วนที่แก้ไข] นำข้อมูลใหม่มาแสดงผล
          row.innerHTML = `
              <td>${p.ProjectName || '-'}</td>
              <td>${p.ProjectTypeName || '-'}</td>
              <td>${p.ProjectOwnerName || '-'}</td>
              <td>${p.PackageNamesDisplay || '-'}</td>
              <td>
                  <button type="button" class="btn btn-xs btn-outline-warning" title="แก้ไข" onclick='prepareEditProjectModal(${projectJsonString})'><i class="fas fa-edit"></i></button>
                  <button type="button" class="btn btn-xs btn-outline-danger" title="ลบ" onclick="handleDeleteProject('${p.Id}', '${p.VendorId}')"><i class="fas fa-trash-alt"></i></button>
              </td>
          `;
      });
  }

  // ==================== FORM & MODAL LOGIC ====================
  function loadInitialDataForModal() { 
    if (availablePackages.length === 0) loadPackagesIntoSelect(); 
    if (availableStatuses.length === 0) loadStatusesIntoSelect(); 
    if (availableProjectTypes.length === 0) loadProjectTypesForModal(); 
    if (availableProjectOwners.length === 0) loadProjectOwnersForModal(); 
    if (availableCompanyTypes.length === 0) loadCompanyTypesIntoSelect();
  }
  function loadPackagesIntoSelect() { 
    return serverCall('getAllPackagesForSelection').then(packages => { 
      availablePackages = packages; 
      const selects = [document.getElementById('packageIds'), document.getElementById('projectPackageIds')]; 
      selects.forEach(select => { 
        if (select) { select.innerHTML = ''; 
          packages.forEach(pkg => {
            select.add(new Option(pkg.DisplayName, pkg.Id));  
          }); 
        } 
      }); 
    }).catch(handleServerError); }
  function loadStatusesIntoSelect() { return serverCall('getAllVendorStatuses').then(statuses => { availableStatuses = statuses; const select = document.getElementById('status'); select.innerHTML = ''; statuses.forEach(stat => select.add(new Option(stat.Name, stat.Id))); }).catch(handleServerError); }
  function loadCompanyTypesIntoSelect() {
    return serverCall('getAllCompanyTypes').then(types => {
      availableCompanyTypes = types;
      const select = document.getElementById('companyTypeId');
      select.innerHTML = '<option value="" disabled>-- กรุณาเลือก --</option>';
      types.forEach(type => select.add(new Option(type.Name, type.Id)));
    }).catch(handleServerError);
  }  
  function loadProjectTypesForModal() { return serverCall('getAllProjectTypes').then(data => { availableProjectTypes = data; const select = document.getElementById('projectTypeId'); select.innerHTML = '<option value="">-- กรุณาเลือก --</option>'; data.forEach(item => select.add(new Option(item.Name, item.Id))); }).catch(handleServerError); }
  
  function loadProjectOwnersForModal(selectedValue = null) {
      if ($('#projectOwnerId').data('select2')) {
          $('#projectOwnerId').select2('destroy');
      }
      return serverCall('getAllProjectOwners').then(data => {
          availableProjectOwners = data;
          const select = document.getElementById('projectOwnerId');
          // เก็บ option 'อื่นๆ' ไว้ก่อน
          const otherOption = select.querySelector('option[value="other"]');
          select.innerHTML = '<option value="">-- กรุณาเลือก --</option>';
          
          data.forEach(item => {
              select.add(new Option(item.NameThai, item.Id));
          });
          // นำ option 'อื่นๆ' กลับมาต่อท้าย
          if(otherOption) select.appendChild(otherOption);

          // ถ้ามีค่าที่เคยเลือกไว้ ให้ตั้งค่านั้นกลับไป
          if(selectedValue) {
              select.value = selectedValue;
          }

          // สร้าง Select2 Instance
          $('#projectOwnerId').select2({
              theme: 'bootstrap4',
              dropdownParent: $('#projectModal')
          });
          // สั่งให้ Select2 อัปเดตการแสดงผล
          $('#projectOwnerId').trigger('change.select2');
      }).catch(handleServerError);
  }

  // [NEW] ฟังก์ชันสำหรับเปิด Modal ย่อย
function prepareAddProjectOwnerSubModal() {
    document.getElementById('projectOwnerSubForm').reset();
    // ดึง option จาก dropdown หลักมาใส่ใน dropdown ของ modal ย่อย
    const mainCompanyTypeSelect = document.getElementById('companyTypeId'); // dropdown จาก modal หลัก
    const subCompanyTypeSelect = document.getElementById('sub_companyTypeId');
    subCompanyTypeSelect.innerHTML = mainCompanyTypeSelect.innerHTML;
    subCompanyTypeSelect.value = '';

    // ซ่อน modal หลักชั่วคราวเพื่อให้ modal ย่อยแสดงผลด้านหน้า
    $('#projectModal').css('z-index', 1040); 
    $('#projectOwnerSubModal').modal('show');
    
    // เมื่อ modal ย่อยถูกปิด, คืนค่า z-index ของ modal หลัก
    $('#projectOwnerSubModal').on('hidden.bs.modal', function () {
        $('#projectModal').css('z-index', 1050);
        $(this).off('hidden.bs.modal'); // ลบ event listener ทิ้งไป
    });
}

// [NEW] ฟังก์ชันสำหรับบันทึกข้อมูลจาก Modal ย่อย
async function handleSaveNewProjectOwner() {
    const saveButton = document.getElementById('saveNewProjectOwnerBtn');
    setLoading(saveButton, true);

    const formData = {
        Id: '', // เป็นการเพิ่มใหม่เสมอ
        NameThai: document.getElementById('sub_nameThai').value,
        NameEnglish: document.getElementById('sub_nameEnglish').value,
        Nickname: document.getElementById('sub_nickname').value,
        CompanyTypeId: document.getElementById('sub_companyTypeId').value,
        IsLargeCompany: document.getElementById('sub_isLargeCompany').checked,
        Remark: document.getElementById('sub_remark').value
    };

    try {
        const response = await serverCall('processAddOrEditProjectOwner', formData);
        if (response.success) {
            showToast(response.message, true);
            $('#projectOwnerSubModal').modal('hide');
            // หลังจากบันทึกสำเร็จ ให้โหลดข้อมูลเจ้าของโครงการใหม่ทั้งหมด
            // และเลือกรายการล่าสุดที่เพิ่งเพิ่มเข้าไป
            const allOwners = await serverCall('getAllProjectOwners');
            const newOwner = allOwners.sort((a,b) => b.Id.localeCompare(a.Id))[0];
            await loadProjectOwnersForModal(newOwner.Id);
        } else {
            showToast(response.message, false);
        }
    } catch (err) {
        handleServerError(err);
    } finally {
        setLoading(saveButton, false);
    }
}

function populateForm(data) {
    document.getElementById('vendorForm').reset();
    document.getElementById('vendorId').value = data.Id;
    document.getElementById('folderId').value = data.FolderId || '';
    document.getElementById('nameThai').value = data.NameThai;
    document.getElementById('nameEnglish').value = data.NameEnglish || '';
    document.getElementById('websiteUrl').value = data.WebsiteUrl || '';
    document.getElementById('socialUrl').value = data.SocialUrl || '';
    document.getElementById('status').value = data.StatusId;
    document.getElementById('remark').value = data.Remark || '';
    document.getElementById('companyTypeId').value = data.CompanyTypeId;
    document.getElementById('registeredCapital').value = data.RegisteredCapital || '';
    document.getElementById('registeredDate').value = data.RegisteredDate ? new Date(data.RegisteredDate).toISOString().split('T')[0] : '';
    document.getElementById('registeredObject').value = data.RegisteredObject || '';

    const folderLink = document.getElementById('vendor-folder-link');
    if (data.FolderId) {
        // [FIX] สร้าง URL จากส่วนต่างๆ เพื่อความปลอดภัย
        folderLink.href = 'https://' + 'drive.google.com/drive/folders/' + data.FolderId;
        folderLink.style.display = 'inline-block';
    } else {
        folderLink.style.display = 'none';
    }

    const fileFields = [
        { key: 'CompanyProfileFolderId', linkId: 'companyProfileFileLink', containerId: 'companyProfileFileLinkContainer', noFileId: 'noCompanyProfileFile' },
        { key: 'IdCardFolderId', linkId: 'idCardFileLink', containerId: 'idCardFileLinkContainer', noFileId: 'noIdCardFile' },
        { key: 'CompanyCertFolderId', linkId: 'companyCertFileLink', containerId: 'companyCertFileLinkContainer', noFileId: 'noCompanyCertFile' },
        { key: 'VatCertFolderId', linkId: 'vatCertFileLink', containerId: 'vatCertFileLinkContainer', noFileId: 'noVatCertFile' },
        { key: 'BookBankFolderId', linkId: 'bookBankFileLink', containerId: 'bookBankFileLinkContainer', noFileId: 'noBookBankFile' }
    ];

    fileFields.forEach(field => {
        const folderId = data[field.key];
        const linkContainer = document.getElementById(field.containerId);
        const link = document.getElementById(field.linkId);
        const noFileSpan = document.getElementById(field.noFileId);

        if (folderId) {
            // [FIX] สร้าง URL จากส่วนต่างๆ เพื่อความปลอดภัย
            link.href = 'https://' + 'drive.google.com/drive/folders/' + folderId;
            linkContainer.style.display = 'block';
            noFileSpan.style.display = 'none';
        } else {
            linkContainer.style.display = 'none';
            noFileSpan.style.display = 'inline';
        }
    });
}

async function handleSaveVendor() { 
    const saveButton = document.getElementById('saveVendorButton'); 
    const form = document.getElementById('vendorForm'); 
    
    if ($('#packageIds').val().length === 0) { 
      showToast('กรุณาเลือกประเภทพัสดุอย่างน้อย 1 รายการ', false); 
      return; 
    } 
    if (!form.checkValidity()) { 
      form.reportValidity(); 
      showToast('กรุณากรอกข้อมูลที่จำเป็นให้ครบถ้วน', false); 
      return; 
    } 
    setLoading(saveButton, true); 
    
    try { 
      // [CORRECTED] สร้าง formData ให้ถูกต้องโดยไม่มี Key ซ้ำซ้อน
      const formData = { 
        Id: document.getElementById('vendorId').value, 
        FolderId: document.getElementById('folderId').value,
        NameThai: document.getElementById('nameThai').value, 
        NameEnglish: document.getElementById('nameEnglish').value, 
        WebsiteUrl: document.getElementById('websiteUrl').value,
        SocialUrl: document.getElementById('socialUrl').value,
        PackageId: $('#packageIds').val(), 
        StatusId: document.getElementById('status').value, 
        Remark: document.getElementById('remark').value, 
        CompanyTypeId: document.getElementById('companyTypeId').value,
        RegisteredCapital: document.getElementById('registeredCapital').value,
        RegisteredDate: document.getElementById('registeredDate').value,
        RegisteredObject: document.getElementById('registeredObject').value
      }; 
      
      const fileInputs = form.querySelectorAll('input[type="file"]'); 
      const filePromises = []; 
      const fileData = {}; 
      
      fileInputs.forEach(input => { 
        if (input.files.length > 0) { 
          const file = input.files[0]; 
          const promise = new Promise((resolve, reject) => { 
            const reader = new FileReader(); 
            reader.onload = (e) => { 
              fileData[input.id] = { fileName: file.name, mimeType: file.type, base64: e.target.result.split(',')[1] }; 
              resolve(); 
            }; 
            reader.onerror = reject; 
            reader.readAsDataURL(file); 
          }); 
          filePromises.push(promise); 
        } 
      }); 
      
      await Promise.all(filePromises); 
      const response = await serverCall('processAddOrEditVendor', formData, fileData); 
      
      if (response.success) { 
        showToast(response.message, true); 
        $('#vendorModal').modal('hide'); 
        fetchAndRenderVendors(); 
      } else { 
        showToast(response.message, false); 
      } 
    } catch (err) { 
      handleServerError(err); 
    } finally { 
      setLoading(saveButton, false); 
    } 
}
  
  
  async function handleSaveContact() { const form = document.getElementById('contactForm'); if (!form.checkValidity()) { form.reportValidity(); return; } const saveButton = document.getElementById('saveContactButton'); setLoading(saveButton, true); const formData = { Id: document.getElementById('contactId').value, VendorId: document.getElementById('contactVendorId').value, Name: document.getElementById('contactName').value, Position: document.getElementById('contactPosition').value, Email: document.getElementById('contactEmail').value, PhoneNumber: "'" + document.getElementById('contactPhoneNumber').value, LineId: document.getElementById('contactLineId').value, }; try { const response = await serverCall('processAddOrEditContact', formData); if (response.success) { showToast(response.message, true); renderContactsTable(response.data); $('#contactModal').modal('hide'); } else { showToast(response.message, false); } } catch (err) { handleServerError(err); } finally { setLoading(saveButton, false); } }
  
  async function handleSaveBoardMember() {
    const form = document.getElementById('boardMemberForm');
    if (!form.checkValidity()) { form.reportValidity(); return; }
    
    const saveButton = document.getElementById('saveBoardMemberButton');
    setLoading(saveButton, true);
    
    const formData = {
        Id: document.getElementById('boardMemberId').value,
        VendorId: document.getElementById('boardMemberVendorId').value,
        Name: document.getElementById('boardMemberName').value,
        Surname: document.getElementById('boardMemberSurname').value,
    };
    
    try {
        const response = await serverCall('processAddOrEditBoardMember', formData);
        if (response.success) {
            renderBoardMembersTable(response.data);
            $('#boardMemberModal').modal('hide');

            // [NEW] ตรวจสอบและแสดงการแจ้งเตือนความสัมพันธ์
            if (response.relationshipWarning) {
                // ใช้ Swal.fire เพื่อให้ผู้ใช้เห็นการแจ้งเตือนที่ชัดเจน
                Swal.fire({
                    title: 'บันทึกสำเร็จ!',
                    text: response.relationshipWarning, // ข้อความแจ้งเตือนจาก Server
                    icon: 'warning' // ใช้ไอคอนสีเหลืองเพื่อเน้นความสำคัญ
                });
            } else {
                showToast(response.message, true); // หากไม่มีอะไรพิเศษ ก็แสดง Toast ปกติ
            }
            // รีเฟรชตาราง Vendor หลักเพื่อให้ไอคอนอัปเดต
            fetchAndRenderVendors(); 

        } else {
            showToast(response.message, false);
        }
    } catch (err) {
        handleServerError(err);
    } finally {
        setLoading(saveButton, false);
    }
  }
  async function handleSaveFinanceRecord() {
    const form = document.getElementById('financeForm');
    if (!form.checkValidity()) {
        form.reportValidity();
        return;
    }
    const saveButton = document.getElementById('saveFinanceButton');
    setLoading(saveButton, true);

    const formData = {
        Id: document.getElementById('financeId').value,
        VendorId: document.getElementById('financeVendorId').value,
        Year: document.getElementById('financeYear').value,
        Revenue: document.getElementById('financeRevenue').value,
        CurrentAssets: document.getElementById('financeCurrentAssets').value,
        CurrentLiabilities: document.getElementById('financeCurrentLiabilities').value,
        TotalLiabilities: document.getElementById('financeTotalLiabilities').value,
    };

    // [แก้ไข] ลบ Logic การอ่านไฟล์ทั้งหมด
    try {
        // ส่ง formData ไปอย่างเดียว ไม่มี fileData
        const response = await serverCall('processAddOrEditFinanceRecord', formData); 
        if (response.success) {
            showToast(response.message, true);
            renderFinanceTable(response.data);
            $('#financeModal').modal('hide');
        } else {
            showToast(response.message, false);
        }
    } catch (err) {
        handleServerError(err);
    } finally {
        setLoading(saveButton, false);
    }
  }
  async function handleSaveProject() {
    const form = document.getElementById('projectForm');
    if (!form.checkValidity()) { form.reportValidity(); return; }
    if (document.getElementById('projectOwnerId').value === 'other' && !document.getElementById('projectOwnerCustom').value) { showToast('กรุณาระบุชื่อเจ้าของโครงการ', false); return; }

    const saveButton = document.getElementById('saveProjectButton');
    setLoading(saveButton, true, 'กำลังบันทึก...');

    try {
      const formData = {
        Id: document.getElementById('projectId').value,
        VendorId: document.getElementById('projectVendorId').value,
        ProjectName: document.getElementById('projectName').value,
        ProjectYear: document.getElementById('projectYear').value,
        ContractValue: document.getElementById('contractValue').value,
        ProjectDescription: document.getElementById('projectDescription').value,
        ProjectTypeId: document.getElementById('projectTypeId').value,
        ProjectOwnerId: document.getElementById('projectOwnerId').value,
        ProjectOwnerCustom: document.getElementById('projectOwnerCustom').value,
        PackageIds: $('#projectPackageIds').val(),
      };

      // ลบส่วนของการจัดการไฟล์ออกทั้งหมด
      const response = await serverCall('processAddOrEditProject', formData, {}); // ส่ง fileData เป็น object ว่างไปแทน

      if (response.success) {
        showToast(response.message, true);
        renderProjectsTable(response.data);
        $('#projectModal').modal('hide');
      } else {
        showToast(response.message, false);
      }
    } catch (err) {
      handleServerError(err);
    } finally {
      setLoading(saveButton, false);
    }
  };

  // ==================== UI HELPERS & UTILITIES ====================
  function updateSortIcons() { document.querySelectorAll('th[data-column]').forEach(header => { const icon = header.querySelector('i'); const columnOfHeader = header.dataset.column; icon.className = 'fas fa-sort ml-1 sort-icon'; if (sortState.column === columnOfHeader) { if (sortState.direction === 'asc') { icon.classList.replace('fa-sort', 'fa-sort-up'); } else if (sortState.direction === 'desc') { icon.classList.replace('fa-sort', 'fa-sort-down'); } } }); }
  function toggleFileSections() { 
    // [REVISED] ตรวจสอบเงื่อนไขจากการเลือกใน Dropdown
    const select = document.getElementById('companyTypeId');
    // ตรวจสอบให้แน่ใจว่ามี option ที่ถูกเลือกอยู่
    const selectedOptionText = select.selectedIndex > -1 ? select.options[select.selectedIndex].text : '';
    const isJuristic = selectedOptionText === 'นิติบุคคล';
    
    document.getElementById('juristic-files').style.display = isJuristic ? 'block' : 'none'; 
    document.getElementById('individual-files').style.display = isJuristic ? 'none' : 'block'; 
  }
  function toggleProjectOwnerInput() { const ownerSelect = document.getElementById('projectOwnerId'); const customGroup = document.getElementById('projectOwnerCustomGroup'); const customInput = document.getElementById('projectOwnerCustom'); if (ownerSelect.value === 'other') { customGroup.style.display = 'block'; customInput.required = true; } else { customGroup.style.display = 'none'; customInput.required = false; customInput.value = ''; } }
  function setModalLoading(isLoading) { document.getElementById('modal-loader').style.display = isLoading ? 'block' : 'none'; document.getElementById('vendorForm').style.display = isLoading ? 'none' : 'block'; document.getElementById('saveVendorButton').disabled = isLoading; }
  function setFinanceModalLoading(isLoading) { document.getElementById('finance-modal-loader').style.display = isLoading ? 'block' : 'none'; document.getElementById('financeForm').style.display = isLoading ? 'none' : 'block'; document.getElementById('saveFinanceButton').disabled = isLoading; }
</script>